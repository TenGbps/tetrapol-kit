#include <stdio.h>
#include "constants.h"
#include "radio.h"
#include <string.h>
#include <stdlib.h>


int main(int argc, char* argv[]) {
	int j;
	char b[68] = {0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1};

	int SCR;

	SCR=7;
//	for (j=0; j<=67; j++)
//		b[j]=j%2;
	
	printf("b=");
	print_buf(b,68);



// 6.2.1 
	char d[74];
	for(j=0;j<74;j++) d[j]=2;

	d[0] = 1;
	for (j=0; j<=67; j++)
		d[j+1] = b[j];

	char *crc;

	crc = make_crc(d, 69);
	for (j=0; j<5; j++)
		d[j+69] = crc[j];
	free(crc);

	printf("d=");
	print_buf(d,74);


	char bx[26];

	for(j=0; j<= 25; j++)
		bx[j] = d[j];

	// bx[-1] = d[25];
	// bx[-2] = d[24];

	printf("bx=");
	print_buf(bx,26);


	char bxx[50];

	for(j=0; j<= 47; j++)
		bxx[j] = d[j+26];
	bxx[48] = 0;
	bxx[49] = 0;
	// bxx[-1] = 0;
	// bxx[-2] = 0;

	printf("bxx=");
	print_buf(bxx,50);
		

// 6.2.2
	char c[152];
	for(j=0; j<152; j++) c[j] = 2;

	c[0] = bx[0] ^ d[25] ^ d[24];		// j=0
	c[1] = bx[0] ^ d[24];

	c[2] = bx[1] ^ bx[0] ^ d[25];		// j=1
	c[3] = bx[1] ^ d[25];

	for(j=2; j<= 25; j++) {			//j=2..25
		c[2*j] = bx[j] ^ bx[j-1] ^ bx[j-2];
		c[2*j+1] = bx[j] ^ bx[j-2];
	}


	c[52] = bxx[0] ^ 0 ^ 0; 		//j=0
	c[53] = bxx[0] ^ 0;

	c[54] = bxx[1] ^ bxx[0] ^ 0;		//j=1
	c[55] = bxx[1] ^ 0;
	for(j=2; j<= 49; j++) { 		//j=2..49
		c[2*j+52] = bxx[j] ^ bxx[j-1] ^ bxx[j-2];
		c[2*j+53] = bxx[j] ^ bxx[j-2];
	}

	printf("c=");
	print_buf(c,152);


// 6.2.4.1

	int K[] = {1, 77, 38, 114, 20, 96, 59, 135, 3, 79, 41, 117, 23, 99, 62, 138, 5, 81, 44, 120, 26, 102, 65, 141, 8, 84, 47, 123, 29, 105, 68, 144, 11, 87, 50, 126, 32, 108, 71, 147, 14, 90, 53, 129, 35, 111, 74, 150, 17, 93, 56, 132, 37, 112, 76, 148, 2, 88, 40, 115, 19, 97, 58, 133, 4, 75, 43, 118, 22, 100, 61, 136, 7, 85, 46, 121, 25, 103, 64, 139, 10, 82, 49, 124, 28, 106, 67, 142, 13, 91, 52, 127, 31, 109, 73, 145, 16, 94, 55, 130, 34, 113, 70, 151, 0, 80, 39, 116, 21, 95, 57, 134, 6, 78, 42, 119, 24, 98, 60, 137, 9, 83, 45, 122, 27, 101, 63, 140, 12, 86, 48, 125, 30, 104, 66, 143, 15, 89, 51, 128, 33, 107, 69, 146, 18, 92, 54, 131, 36, 110, 72, 149 };

	char e[152];
	for(j=0; j<= 151; j++) e[j] = 2;
	int k;

	for(j=0; j<= 151; j++) {
		k=K[j];
		e[k] = c[j];
	}

	printf("e=");
	print_buf(e,152);


// 6.2.4.2

	char ex[152];

	ex[0] = e[0] ^ 0; 		//f7
	for(j=1; j<= 151; j++)
		if (is_in_code(j)) 
			ex[j] = e[j] ^ ex[j-2];
		else
			ex[j] = e[j] ^ ex[j-1];

	printf("ex=");
	print_buf(ex,152);

// 6.2.5.1

	char s[127];

	s[0] = 1;
	s[1] = 1;
	s[2] = 1;
	s[3] = 1;
	s[4] = 1;
	s[5] = 1;
	s[6] = 1;
	for(j=7; j<= 127; j++)
		s[j] = s[j-1] ^ s[j-7];

	printf("s=");
	print_buf(s,127);

	
// 6.2.5.2

	char f[160];

	f[0] = 0;
	f[1] = 1;
	f[2] = 1;
	f[3] = 0;
	f[4] = 0;
	f[5] = 0;
	f[6] = 1;
	f[7] = 0;

	for(j=0; j<= 151; j++) {
		if (SCR > 0)
			f[j+8] = ex[j] ^ s[(j+SCR)%127];
		else
			f[j+8] = ex[j];
	}

	printf("f=");
	print_buf(f,160);
}
